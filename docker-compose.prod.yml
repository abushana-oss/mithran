
# Production Docker Compose for Mithran Platform
version: '3.8'

services:
  cad-engine:
    build:
      context: ./cad-engine
      dockerfile: Dockerfile
    container_name: mithran-cad-engine-prod
    environment:
      PORT: 5000
      NODE_ENV: production
      PYTHONUNBUFFERED: 1
      CORS_ORIGINS: http://localhost:3000,http://localhost:4000
      MAX_FILE_SIZE_MB: 50
      RATE_LIMIT_PER_MINUTE: 10
      LINEAR_DEFLECTION: 0.1
      ANGULAR_DEFLECTION: 0.5
      LOG_LEVEL: info
    ports:
      - "5000:5000"
    volumes:
      - cad-temp:/tmp/cad-files
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M

  frontend:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        NEXT_PUBLIC_API_GATEWAY_URL: http://localhost:4000
        NEXT_PUBLIC_SUPABASE_URL: https://iuvtsvjpmovfymvnmqys.supabase.co
        NEXT_PUBLIC_SUPABASE_ANON_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1dnRzdmpwbW92Znltdm5tcXlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzUxMjk2NjIsImV4cCI6MjA1MDcwNTY2Mn0.sb_publishable_9Lijw5z0vmAL6vNJaxcWuA_Z3V4O_F5
        NEXT_PUBLIC_CAD_ENGINE_URL: http://localhost:5000
    container_name: mithran-frontend-prod
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_CAD_ENGINE_URL: http://localhost:5000
    ports:
      - "3000:3000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: mithran-backend-prod
    environment:
      NODE_ENV: production
      PORT: 4000
      SUPABASE_URL: https://iuvtsvjpmovfymvnmqys.supabase.co
      SUPABASE_SERVICE_KEY: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Iml1dnRzdmpwbW92Znltdm5tcXlzIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTczNTEyOTY2MiwiZXhwIjoyMDUwNzA1NjYyfQ.sb_publishable_9Lijw5z0vmAL6vNJaxcWuA_Z3V4O_F5
      JWT_SECRET: production_jwt_secret_key_here
      CORS_ORIGIN: http://localhost:3000
      CAD_ENGINE_URL: http://cad-engine:5000
    ports:
      - "4000:4000"
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      - cad-engine

volumes:
  cad-temp:
    driver: local

networks:
  default:
    driver: bridge